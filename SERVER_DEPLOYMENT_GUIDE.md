# ç»Ÿè®¡æ±‡æ€»æœåŠ¡å™¨éƒ¨ç½²æ•™ç¨‹ï¼ˆå°ç™½ç‰ˆï¼‰

## ğŸ“‹ å‡†å¤‡å·¥ä½œ

### 1. è´­ä¹°è…¾è®¯äº‘æœåŠ¡å™¨

1. ç™»å½• [è…¾è®¯äº‘æ§åˆ¶å°](https://console.cloud.tencent.com/)
2. è¿›å…¥ã€Œäº‘æœåŠ¡å™¨ CVMã€
3. ç‚¹å‡»ã€Œæ–°å»ºã€
4. é€‰æ‹©é…ç½®ï¼š
   - **åœ°åŸŸ**: é€‰æ‹©ç¦»ä½ äº¤æ˜“æœåŠ¡å™¨è¿‘çš„åœ°åŸŸï¼ˆæ¯”å¦‚é¦™æ¸¯ã€æ–°åŠ å¡ï¼‰
   - **æœºå‹**: æœ€ä½é…ç½®å³å¯ï¼ˆ1æ ¸2G è¶³å¤Ÿï¼‰
   - **é•œåƒ**: Ubuntu 22.04 LTS
   - **å…¬ç½‘å¸¦å®½**: 1Mbps å³å¯
   - **å®‰å…¨ç»„**: å‹¾é€‰ã€Œæ”¾é€šå…¨éƒ¨ç«¯å£ã€ï¼ˆæˆ–åç»­æ‰‹åŠ¨å¼€æ”¾ 3000 ç«¯å£ï¼‰
5. è®¾ç½®ç™»å½•å¯†ç ï¼ˆè®°ä½è¿™ä¸ªå¯†ç ï¼ï¼‰
6. è´­ä¹°å¹¶ç­‰å¾…æœåŠ¡å™¨åˆ›å»ºå®Œæˆ

### 2. è·å–æœåŠ¡å™¨ä¿¡æ¯

åœ¨è…¾è®¯äº‘æ§åˆ¶å°æ‰¾åˆ°ä½ çš„æœåŠ¡å™¨ï¼Œè®°å½•ï¼š
- **å…¬ç½‘ IP**: ä¾‹å¦‚ `43.123.45.67`
- **ç™»å½•å¯†ç **: ä½ åˆšæ‰è®¾ç½®çš„å¯†ç 

---

## ğŸ”Œ ç¬¬ä¸€æ­¥ï¼šè¿æ¥åˆ°æœåŠ¡å™¨

### Windows ç”¨æˆ·

1. ä¸‹è½½å¹¶å®‰è£… [PuTTY](https://www.putty.org/) æˆ– [MobaXterm](https://mobaxterm.mobatek.net/)
2. æ‰“å¼€è½¯ä»¶ï¼Œè¾“å…¥ï¼š
   - **Host Name**: ä½ çš„æœåŠ¡å™¨å…¬ç½‘ IPï¼ˆä¾‹å¦‚ `43.123.45.67`ï¼‰
   - **Port**: `22`
   - **Connection Type**: `SSH`
3. ç‚¹å‡»ã€ŒOpenã€è¿æ¥
4. è¾“å…¥ç”¨æˆ·åï¼š`ubuntu`
5. è¾“å…¥å¯†ç ï¼ˆåˆšæ‰è®¾ç½®çš„å¯†ç ï¼Œè¾“å…¥æ—¶ä¸ä¼šæ˜¾ç¤ºï¼Œè¾“å®Œç›´æ¥æŒ‰å›è½¦ï¼‰

### Mac/Linux ç”¨æˆ·

æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ï¼š
```bash
ssh ubuntu@43.123.45.67
# å°† 43.123.45.67 æ›¿æ¢æˆä½ çš„æœåŠ¡å™¨ IP
```
è¾“å…¥å¯†ç åæŒ‰å›è½¦ã€‚

---

## ğŸ› ï¸ ç¬¬äºŒæ­¥ï¼šå®‰è£…å¿…è¦è½¯ä»¶

è¿æ¥æˆåŠŸåï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼ `ubuntu@VM-xxx:~$` çš„æç¤ºç¬¦ã€‚

### 1. æ›´æ–°ç³»ç»Ÿ

```bash
sudo apt update && sudo apt upgrade -y
```

ç­‰å¾…å®Œæˆï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰ã€‚

### 2. å®‰è£… Bunï¼ˆJavaScript è¿è¡Œæ—¶ï¼‰

```bash
curl -fsSL https://bun.sh/install | bash
```

å®‰è£…å®Œæˆåï¼Œæ‰§è¡Œï¼š
```bash
source ~/.bashrc
```

éªŒè¯å®‰è£…ï¼š
```bash
bun --version
```

å¦‚æœæ˜¾ç¤ºç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ `1.0.0`ï¼‰ï¼Œè¯´æ˜å®‰è£…æˆåŠŸã€‚

### 3. å®‰è£… Git

```bash
sudo apt install git -y
```

éªŒè¯å®‰è£…ï¼š
```bash
git --version
```

---

## ğŸ“¥ ç¬¬ä¸‰æ­¥ï¼šä¸‹è½½ä»£ç 

### 1. å…‹éš†ä½ çš„ä»“åº“

```bash
cd ~
git clone https://github.com/yuggg-cyber/ritmex-bot.git
cd ritmex-bot
```

### 2. éªŒè¯æ–‡ä»¶

```bash
ls src/stats_system/
```

åº”è¯¥çœ‹åˆ°ï¼š
```
collector.ts  index.ts  README.md  reporter.ts  server.ts
```

---

## âš™ï¸ ç¬¬å››æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

### 1. åˆ›å»ºé…ç½®æ–‡ä»¶

```bash
nano .env
```

è¿™ä¼šæ‰“å¼€ä¸€ä¸ªæ–‡æœ¬ç¼–è¾‘å™¨ã€‚

### 2. ç²˜è´´ä»¥ä¸‹å†…å®¹

```bash
# ç»Ÿè®¡ç³»ç»Ÿé…ç½®
ENABLE_STATS=true
STATS_ROLE=SERVER
STATS_SERVER_PORT=3000
DINGTALK_TOKEN=
```

### 3. è·å–é’‰é’‰æœºå™¨äºº Token

#### 3.1 åˆ›å»ºé’‰é’‰ç¾¤æœºå™¨äºº

1. æ‰“å¼€é’‰é’‰ï¼Œåˆ›å»ºä¸€ä¸ªç¾¤ï¼ˆæˆ–ä½¿ç”¨ç°æœ‰ç¾¤ï¼‰
2. ç‚¹å‡»ç¾¤è®¾ç½® â†’ æ™ºèƒ½ç¾¤åŠ©æ‰‹ â†’ æ·»åŠ æœºå™¨äºº â†’ è‡ªå®šä¹‰
3. è®¾ç½®æœºå™¨äººåç§°ï¼š`äº¤æ˜“ç»Ÿè®¡æ’­æŠ¥`
4. å®‰å…¨è®¾ç½®ï¼šé€‰æ‹©ã€Œè‡ªå®šä¹‰å…³é”®è¯ã€ï¼Œè¾“å…¥ï¼š`ç»Ÿè®¡`
5. ç‚¹å‡»ã€Œå®Œæˆã€
6. **å¤åˆ¶ Webhook åœ°å€**ï¼Œä¾‹å¦‚ï¼š
   ```
   https://oapi.dingtalk.com/robot/send?access_token=abcd1234567890xyz
   ```
7. æå– `access_token=` åé¢çš„éƒ¨åˆ†ï¼š`abcd1234567890xyz`

#### 3.2 å¡«å†™ Token

åœ¨ nano ç¼–è¾‘å™¨ä¸­ï¼Œå°†å…‰æ ‡ç§»åŠ¨åˆ° `DINGTALK_TOKEN=` åé¢ï¼Œç²˜è´´ä½ çš„ tokenï¼š

```bash
DINGTALK_TOKEN=abcd1234567890xyz
```

### 4. ä¿å­˜å¹¶é€€å‡º

- æŒ‰ `Ctrl + O`ï¼ˆä¿å­˜ï¼‰
- æŒ‰ `Enter`ï¼ˆç¡®è®¤æ–‡ä»¶åï¼‰
- æŒ‰ `Ctrl + X`ï¼ˆé€€å‡ºï¼‰

### 5. éªŒè¯é…ç½®

```bash
cat .env
```

ç¡®è®¤å†…å®¹æ­£ç¡®ã€‚

---

## ğŸš€ ç¬¬äº”æ­¥ï¼šå¯åŠ¨æœåŠ¡å™¨

### 1. æµ‹è¯•è¿è¡Œ

```bash
bun run src/stats_system/server.ts
```

ä½ åº”è¯¥çœ‹åˆ°ï¼š
```
[StatsServer] ç›‘å¬ç«¯å£ 3000
[StatsServer] å°†åœ¨ XXXs åé¦–æ¬¡æ’­æŠ¥
[StatsServer] æœåŠ¡å·²å¯åŠ¨
```

### 2. æµ‹è¯•å¥åº·æ£€æŸ¥

**ä¿æŒæœåŠ¡å™¨è¿è¡Œ**ï¼Œæ‰“å¼€ä¸€ä¸ª**æ–°çš„ç»ˆç«¯çª—å£**ï¼Œå†æ¬¡è¿æ¥åˆ°æœåŠ¡å™¨ï¼š

```bash
ssh ubuntu@43.123.45.67
```

ç„¶åæ‰§è¡Œï¼š
```bash
curl http://localhost:3000/health
```

å¦‚æœè¿”å› `OK`ï¼Œè¯´æ˜æœåŠ¡æ­£å¸¸è¿è¡Œï¼

### 3. åœæ­¢æµ‹è¯•

å›åˆ°ç¬¬ä¸€ä¸ªç»ˆç«¯çª—å£ï¼ŒæŒ‰ `Ctrl + C` åœæ­¢æœåŠ¡ã€‚

---

## ğŸ”’ ç¬¬å…­æ­¥ï¼šé…ç½®é˜²ç«å¢™

### 1. å¼€æ”¾ 3000 ç«¯å£

```bash
sudo ufw allow 3000/tcp
sudo ufw enable
```

å¦‚æœæç¤º `Command may disrupt existing ssh connections`ï¼Œè¾“å…¥ `y` å¹¶å›è½¦ã€‚

### 2. åœ¨è…¾è®¯äº‘æ§åˆ¶å°é…ç½®å®‰å…¨ç»„

1. è¿›å…¥è…¾è®¯äº‘æ§åˆ¶å° â†’ äº‘æœåŠ¡å™¨
2. ç‚¹å‡»ä½ çš„æœåŠ¡å™¨ â†’ å®‰å…¨ç»„
3. ç‚¹å‡»ã€Œä¿®æ”¹è§„åˆ™ã€
4. æ·»åŠ å…¥ç«™è§„åˆ™ï¼š
   - **ç±»å‹**: è‡ªå®šä¹‰
   - **æ¥æº**: 0.0.0.0/0
   - **åè®®ç«¯å£**: TCP:3000
   - **ç­–ç•¥**: å…è®¸
5. ä¿å­˜

### 3. æµ‹è¯•å¤–ç½‘è®¿é—®

åœ¨ä½ çš„**æœ¬åœ°ç”µè„‘**æµè§ˆå™¨ä¸­è®¿é—®ï¼š
```
http://43.123.45.67:3000/health
```
ï¼ˆå°† IP æ›¿æ¢æˆä½ çš„æœåŠ¡å™¨ IPï¼‰

å¦‚æœæ˜¾ç¤º `OK`ï¼Œè¯´æ˜å¤–ç½‘å¯ä»¥è®¿é—®ï¼

---

## ğŸ”„ ç¬¬ä¸ƒæ­¥ï¼šè®¾ç½®å¼€æœºè‡ªå¯åŠ¨

### 1. åˆ›å»º systemd æœåŠ¡

```bash
sudo nano /etc/systemd/system/stats-server.service
```

ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼ˆ**æ³¨æ„æ›¿æ¢è·¯å¾„**ï¼‰ï¼š

```ini
[Unit]
Description=Stats Aggregation Server
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/ritmex-bot
ExecStart=/home/ubuntu/.bun/bin/bun run src/stats_system/server.ts
Restart=always
RestartSec=10
Environment="NODE_ENV=production"

[Install]
WantedBy=multi-user.target
```

ä¿å­˜å¹¶é€€å‡ºï¼ˆ`Ctrl + O`ï¼Œ`Enter`ï¼Œ`Ctrl + X`ï¼‰ã€‚

### 2. å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡

```bash
sudo systemctl daemon-reload
sudo systemctl enable stats-server
sudo systemctl start stats-server
```

### 3. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
sudo systemctl status stats-server
```

åº”è¯¥çœ‹åˆ° `Active: active (running)`ã€‚

### 4. æŸ¥çœ‹æ—¥å¿—

```bash
sudo journalctl -u stats-server -f
```

æŒ‰ `Ctrl + C` é€€å‡ºæ—¥å¿—æŸ¥çœ‹ã€‚

---

## ğŸ§ª ç¬¬å…«æ­¥ï¼šæµ‹è¯•å®Œæ•´æµç¨‹

### 1. æ‰‹åŠ¨å‘é€æµ‹è¯•æ•°æ®

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
curl -X POST http://localhost:3000/stats \
  -H "Content-Type: application/json" \
  -d '{
    "botName": "test-bot",
    "timestamp": 1705449600000,
    "placeOrderCount": 10,
    "cancelOrderCount": 5,
    "fillCount": 3,
    "durationMs": 3600000,
    "periodPnl": 12.34,
    "currentPosition": 0.001,
    "accountBalance": 1000.00
  }'
```

### 2. æŸ¥çœ‹æ—¥å¿—

```bash
sudo journalctl -u stats-server -n 20
```

åº”è¯¥çœ‹åˆ°ï¼š
```
[StatsServer] æ”¶åˆ°æ•°æ®: test-bot @ 2024-01-17T00:00:00.000Z
```

---

## ğŸ“Š ç¬¬ä¹æ­¥ï¼šç­‰å¾…é’‰é’‰æ’­æŠ¥

æœåŠ¡å™¨ä¼šåœ¨æ¯å°æ—¶çš„ **02 åˆ†**ï¼ˆä¾‹å¦‚ 14:02ã€15:02ï¼‰è‡ªåŠ¨æ±‡æ€»æ•°æ®å¹¶å‘é€åˆ°é’‰é’‰ã€‚

å¦‚æœä½ æƒ³ç«‹å³æµ‹è¯•é’‰é’‰æ’­æŠ¥ï¼Œå¯ä»¥ï¼š

1. å¤šæ¬¡å‘é€æµ‹è¯•æ•°æ®ï¼ˆå‚è€ƒç¬¬å…«æ­¥ï¼‰
2. ç­‰å¾…ä¸‹ä¸€ä¸ªæ•´ç‚¹çš„ 02 åˆ†
3. æŸ¥çœ‹é’‰é’‰ç¾¤æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯

---

## ğŸ”§ å¸¸ç”¨å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```bash
sudo systemctl status stats-server
```

### é‡å¯æœåŠ¡
```bash
sudo systemctl restart stats-server
```

### åœæ­¢æœåŠ¡
```bash
sudo systemctl stop stats-server
```

### æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
sudo journalctl -u stats-server -f
```

### æŸ¥çœ‹æœ€è¿‘ 50 æ¡æ—¥å¿—
```bash
sudo journalctl -u stats-server -n 50
```

### æ›´æ–°ä»£ç 
```bash
cd ~/ritmex-bot
git pull
sudo systemctl restart stats-server
```

---

## ğŸ“ é…ç½® Client ç«¯

ç°åœ¨ Server ç«¯å·²ç»éƒ¨ç½²å¥½äº†ï¼Œä½ éœ€è¦åœ¨**äº¤æ˜“æœåŠ¡å™¨**ï¼ˆè¿è¡Œ Bot çš„æœºå™¨ï¼‰ä¸Šé…ç½® Client ç«¯ã€‚

åœ¨äº¤æ˜“æœåŠ¡å™¨çš„ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```bash
ENABLE_STATS=true
STATS_ROLE=CLIENT
BOT_NAME=bot-1
STATS_SERVER_URL=http://43.123.45.67:3000/stats
```

**æ³¨æ„**: å°† `43.123.45.67` æ›¿æ¢æˆä½ çš„ Server æœåŠ¡å™¨çš„å…¬ç½‘ IPã€‚

ç„¶åæŒ‰ç…§ `stats_system_patches.md` ä¸­çš„æŒ‡ç¤ºï¼Œåœ¨ä»£ç ä¸­æ’å…¥ç»Ÿè®¡æ¢é’ˆã€‚

---

## â“ å¸¸è§é—®é¢˜

### Q1: æ— æ³•è®¿é—® 3000 ç«¯å£

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥é˜²ç«å¢™ï¼š`sudo ufw status`
2. æ£€æŸ¥è…¾è®¯äº‘å®‰å…¨ç»„æ˜¯å¦å¼€æ”¾ 3000 ç«¯å£
3. æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œï¼š`sudo systemctl status stats-server`

### Q2: æœåŠ¡å¯åŠ¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
sudo journalctl -u stats-server -n 50
```
æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼Œé€šå¸¸æ˜¯é…ç½®æ–‡ä»¶è·¯å¾„æˆ–æƒé™é—®é¢˜ã€‚

### Q3: æ²¡æœ‰æ”¶åˆ°é’‰é’‰æ¶ˆæ¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `DINGTALK_TOKEN` æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥é’‰é’‰æœºå™¨äººçš„å…³é”®è¯è®¾ç½®ï¼ˆå¿…é¡»åŒ…å«ã€Œç»Ÿè®¡ã€ï¼‰
3. æŸ¥çœ‹æ—¥å¿—ï¼š`sudo journalctl -u stats-server -f`

### Q4: å¦‚ä½•ä¿®æ”¹ç«¯å£

ä¿®æ”¹ `.env` ä¸­çš„ `STATS_SERVER_PORT`ï¼Œç„¶åï¼š
```bash
sudo systemctl restart stats-server
```

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ çš„ç»Ÿè®¡æ±‡æ€»æœåŠ¡å™¨å·²ç»éƒ¨ç½²å®Œæˆå¹¶è‡ªåŠ¨è¿è¡Œäº†ï¼

æ¯å°æ—¶çš„ 02 åˆ†ï¼Œå®ƒä¼šè‡ªåŠ¨æ±‡æ€»æ‰€æœ‰ Client çš„æ•°æ®å¹¶å‘é€åˆ°é’‰é’‰ç¾¤ã€‚

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ—¥å¿—ï¼š`sudo journalctl -u stats-server -f`
2. æ£€æŸ¥é…ç½®ï¼š`cat ~/ritmex-bot/.env`
3. æµ‹è¯•è¿é€šæ€§ï¼š`curl http://localhost:3000/health`

ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼ğŸš€
